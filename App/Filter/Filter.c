/*********************************************************************************************************
* 模块名称: XXX.c
* 摘    要: 模块实现具体功能
* 当前版本: 1.0.0
* 作    者: XXX
* 完成日期: 2024年12月14日
* 内    容:
* 注    意:
**********************************************************************************************************
* 取代版本:
* 作    者:
* 完成日期:
* 修改内容:
* 修改文件:
*********************************************************************************************************/

/*********************************************************************************************************
*                                              包含头文件
*********************************************************************************************************/
#include "Filter.h"
#include "DataType.h"
#include "UART1.h"
#include "math.h"

#include "arm_math.h"

/*********************************************************************************************************
*                                              宏定义
*********************************************************************************************************/

/*********************************************************************************************************
*                                              枚举结构体定义
*********************************************************************************************************/
SPO2_Filter_Smooth_Struct SPO2_Filter_RED_Smooth;
SPO2_Filter_Smooth_Struct SPO2_Filter_IR_Smooth;
/*********************************************************************************************************
*                                              内部变量
*********************************************************************************************************/
u8 SPO2_Filter_Flag='0';    //默认有滤波    

//切比雪夫滤波器[low-15]
static arm_biquad_casd_df1_inst_f32 SPO2_RED_Filter_inst;
static arm_biquad_casd_df1_inst_f32 SPO2_IR_Filter_inst;
const uint8_t SPO2_Filter_STAGES = 2;
static float32_t SPO2_RED_Filter_state[SPO2_Filter_STAGES * 4] = {0};// 3. 状态缓存数组（参数4：pState）：2级 × 4 = 8个元素，初始化为0
static float32_t SPO2_IR_Filter_state[SPO2_Filter_STAGES * 4] = {0};// 3. 状态缓存数组（参数4：pState）：2级 × 4 = 8个元素，初始化为0
//const float32_t SPO2_Filter_Coeffs[5 * SPO2_Filter_STAGES] = {  // 2级滤波器，每级5个系数
//1 , -1.176059493776671960318935816758312284946 , 1 , 1.549267754736708635476816198206506669521 , -0.735443326537428165856624673324404284358,
//1 , 0.407658329092028037798911555000813677907 , 1 , 1.205661447809021957766617560992017388344 , -0.384945573724287282146860889042727649212
//};
////增益
//static float  SPO2_Filter_NotchInc = 
//0.225957542315872922378261478115746285766   *                                                                                             
//0.074464106367981494627450445022986968979   ;                                                                                         
//const float32_t SPO2_Filter_Coeffs[5 * SPO2_Filter_STAGES] = {  // 2级滤波器，每级5个系数
//1 , -1.743453007111403829654250330349896103144 , 1 , 1.842363981365810809975869233312550932169 , -0.914018067620557372876533008820842951536,
//1 , -1.651779595443521042597012637997977435589 , 1 , 1.685348786703018131305498172878287732601 , -0.756582085275344096153560258244397118688,
//1 , -1.296028011954835301722255280765239149332 , 1 , 1.544927620302812387720337028440553694963 , -0.619356505835187753916670772014185786247,
//1 , 0.535920490498309698423895497398916631937 , 1 , 1.453510092085423810459587912191636860371 , -0.531218193051814391303366846841527149081
//};
////增益
//static float  SPO2_Filter_NotchInc = 
//0.279301992387265218820147083533811382949   *                                                                                             
//0.204563826933273296138082741890684701502   *                                                                                            
//0.105727055616309947860820273035642458126   *                                                                                             
//0.03064295637720134204973199132382433163   ;                                                                                         
const float32_t SPO2_Filter_Coeffs[5 * SPO2_Filter_STAGES] = {
    // 第一级
    0.014343368f,   // b0
    0.028686736f,   // b1  
    0.014343368f,   // b2
    1.768827860f,   // -a1 (注意：这里是 -a1，取负值)
    -0.826201333f,  // a2
    
    // 第二级
    0.012773570f,   // b0
    0.025547140f,   // b1
    0.012773570f,   // b2
    1.575239978f,   // -a1
    -0.626334259f   // a2
};
// 滤波器增益：你的系数已分别乘以各级增益，此处为两级增益的乘积（直接合并为单个常量）
// 注：你的原始B系数已乘Gain，此处增益为两级Gain的乘积（若需单独验证，可保留原始增益，此处直接简化为最终常量）
static const float32_t SPO2_Filter_NotchInc = 1.0;
/*********************************************************************************************************
*                                              内部函数声明
*********************************************************************************************************/
void SPO2_RED_Filter_IIR(float* x);               //滤波
void SPO2_IR_Filter_IIR(float* x);               //滤波
void BaselineFilterTask_RED(float *dataAddr);      
void BaselineFilterTask_IR(float *dataAddr);      
float SPO2_Filter_Smooth(SPO2_Filter_Smooth_Struct *filter, float newInput) ;
void SPO2_Filter_Smooth_Init(SPO2_Filter_Smooth_Struct *filter);

/*********************************************************************************************************
*                                              内部函数实现
*********************************************************************************************************/
/*********************************************************************************************************
* 函数名称: SPO2_RED_Filter_IIR
* 函数功能: 呼吸IIR滤波
* 输入参数: double* x ：输入数据的地址
            int N ：数据个数
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
void SPO2_RED_Filter_IIR(float* x)
{
    arm_biquad_cascade_df1_f32
  (
      &SPO2_RED_Filter_inst,  // S：已初始化的实例
      x,                              // pIn：输入数据
      x,                              // pOut：输出数据
      1                               // blockSize：单次处理32点
  );
  (*x) *= SPO2_Filter_NotchInc;

  BaselineFilterTask_RED(x);
  
  *x = SPO2_Filter_Smooth(&SPO2_Filter_RED_Smooth, *x);
}
/*********************************************************************************************************
* 函数名称: SPO2_RED_Filter_IIR
* 函数功能: 呼吸IIR滤波
* 输入参数: double* x ：输入数据的地址
            int N ：数据个数
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
void SPO2_IR_Filter_IIR(float* x)
{
    arm_biquad_cascade_df1_f32
  (
      &SPO2_IR_Filter_inst,  // S：已初始化的实例
      x,                              // pIn：输入数据
      x,                              // pOut：输出数据
      1                               // blockSize：单次处理32点
  );
  (*x) *= SPO2_Filter_NotchInc;

  BaselineFilterTask_IR(x);
  
  *x = SPO2_Filter_Smooth(&SPO2_Filter_IR_Smooth, *x);
}

/*********************************************************************************************************
* 函数名称：BaselineFilterTask
* 函数功能：滤波器模块任务
* 输入参数：滤波数据的地址
* 输出参数：void
* 返 回 值：void
* 创建日期：2024年01月22日
* 注  意：  采用IIR型滤波器
**********************************************************************************************************/
void BaselineFilterTask_RED(float *dataAddr)                  
{
	static float b1[3],a1[3];  //第一节滤波系数 
	static float b2[3],a2[3];  //第二节滤波系数
  static float bufX[3],bufY[3];   
	
	b1[0]=1;b1[1]=-2;b1[2]=1;          //滤波器分子系数
	a1[0]=1;a1[1]=-1.990271241;a1[2]= 0.99042;      //滤波器分母系数	
	b2[0]=1;b2[1]=-2;b2[2]=1;          //滤波器分子系数
	a2[0]=1;a2[1]=-1.9768913542871;a2[2]= 0.9770474536;      //滤波器分母系数
  
	bufX[0] = *dataAddr;
	
	bufY[0] = -a1[1]*bufY[1]-a1[2]*bufY[2]+bufX[0]+b1[1]*bufX[1]+bufX[2];//第一节
	
	bufY[0] = -a2[1]*bufY[1]-a2[2]*bufY[2]+bufX[0]+b2[1]*bufX[1]+bufX[2];//第二节
	
	bufY[2]=bufY[1];bufY[1]=bufY[0];
	bufX[2]=bufX[1];bufX[1]=bufX[0];
	
	*dataAddr = bufY[0];
}
/*********************************************************************************************************
* 函数名称：BaselineFilterTask
* 函数功能：滤波器模块任务
* 输入参数：滤波数据的地址
* 输出参数：void
* 返 回 值：void
* 创建日期：2024年01月22日
* 注  意：  采用IIR型滤波器
**********************************************************************************************************/
void BaselineFilterTask_IR(float *dataAddr)                  
{
	static float b1[3],a1[3];  //第一节滤波系数 
	static float b2[3],a2[3];  //第二节滤波系数
  static float bufX[3],bufY[3];   
	
	b1[0]=1;b1[1]=-2;b1[2]=1;          //滤波器分子系数
	a1[0]=1;a1[1]=-1.990271241;a1[2]= 0.99042;      //滤波器分母系数	
	b2[0]=1;b2[1]=-2;b2[2]=1;          //滤波器分子系数
	a2[0]=1;a2[1]=-1.9768913542871;a2[2]= 0.9770474536;      //滤波器分母系数
  
	bufX[0] = *dataAddr;
	
	bufY[0] = -a1[1]*bufY[1]-a1[2]*bufY[2]+bufX[0]+b1[1]*bufX[1]+bufX[2];//第一节
	
	bufY[0] = -a2[1]*bufY[1]-a2[2]*bufY[2]+bufX[0]+b2[1]*bufX[1]+bufX[2];//第二节
	
	bufY[2]=bufY[1];bufY[1]=bufY[0];
	bufX[2]=bufX[1];bufX[1]=bufX[0];
	
	*dataAddr = bufY[0];
}

/*********************************************************************************************************
* 函数名称：Filter_Update
* 函数功能：滤波器模块任务
* 输入参数：滤波数据的地址
* 输出参数：void
* 返 回 值：void
* 创建日期：2024年01月22日
* 注  意：  采用IIR型滤波器
**********************************************************************************************************/
float SPO2_Filter_Smooth(SPO2_Filter_Smooth_Struct *filter, float newInput) {
    // 1. 从总和中减去最老的一个数据（即将被覆盖的数据）
    filter->sum -= filter->buffer[filter->head];

    // 2. 将新数据存入缓冲区当前位置
    filter->buffer[filter->head] = newInput;

    // 3. 将新数据加入总和
    filter->sum += newInput;

    // 4. 更新索引（环形移动）
    filter->head++;
    if (filter->head >= EC_SmoothFILTER_WINDOW_SIZE) {
        filter->head = 0;
    }

    // 5. 返回平均值 (总和 / 12)
    // 注意：整数除法会丢弃小数部分。如果需要四舍五入，可以写成: (filter->sum + FILTER_WINDOW_SIZE/2) / FILTER_WINDOW_SIZE
    return (filter->sum / EC_SmoothFILTER_WINDOW_SIZE);
}
/*********************************************************************************************************
* 函数名称：SPO2_RED_Filter_Smooth_Init
* 函数功能：滤波器模块初始化任务
* 输入参数：滤波数据的地址
* 输出参数：void
* 返 回 值：void
* 创建日期：2024年01月22日
* 注  意：  采用IIR型滤波器
**********************************************************************************************************/
void SPO2_Filter_Smooth_Init(SPO2_Filter_Smooth_Struct *filter) 
{
  int i = 0;
  for (i = 0; i < EC_SmoothFILTER_WINDOW_SIZE; i++) 
  {
    filter->buffer[i] = 0;
  }
  filter->head = 0;
  filter->sum = 0;
}

/*********************************************************************************************************
*                                              API函数实现
*********************************************************************************************************/
/*********************************************************************************************************
* 函数名称: SPO2_RED_Filter
* 函数功能: 呼吸滤波任务主入口
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
void SPO2_RED_Filter(float* x)
{
  switch(SPO2_Filter_Flag)
  {
    case '0':
      break;
    case '1':
      SPO2_RED_Filter_IIR(x);
      break;
    default:
      printf("ERROR:滤波器选择错误");
      break;
  }
}

/*********************************************************************************************************
* 函数名称: SPO2_RED_Filter
* 函数功能: 呼吸滤波任务主入口
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
void SPO2_IR_Filter(float* x)
{
  switch(SPO2_Filter_Flag)
  {
    case '0':
      break;
    case '1':
      SPO2_IR_Filter_IIR(x);
      break;
    default:
      printf("ERROR:滤波器选择错误");
      break;
  }
}

/*********************************************************************************************************
* 函数名称: InitFilter
* 函数功能: 呼吸滤波任务初始化
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
void InitFilter()
{  
  SPO2_Filter_Smooth_Init(&SPO2_Filter_RED_Smooth);
  
    arm_biquad_cascade_df1_init_f32//切比雪夫II
  (
    &SPO2_RED_Filter_inst,  // S：实例地址
    SPO2_Filter_STAGES,               // numStages：2级（4阶）
    (float32_t*)&SPO2_Filter_Coeffs,   // pCoeffs：带通系数
    SPO2_RED_Filter_state     // pState：状态缓存
  );
  
  
  SPO2_Filter_Smooth_Init(&SPO2_Filter_IR_Smooth);
  
    arm_biquad_cascade_df1_init_f32//切比雪夫II
  (
    &SPO2_IR_Filter_inst,  // S：实例地址
    SPO2_Filter_STAGES,               // numStages：2级（4阶）
    (float32_t*)&SPO2_Filter_Coeffs,   // pCoeffs：带通系数
    SPO2_IR_Filter_state     // pState：状态缓存
  );

}
